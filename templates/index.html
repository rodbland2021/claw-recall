<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recall ‚Äî Memory Search</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d9ff;
            font-size: 2.2em;
        }
        .subtitle {
            text-align: center; margin-bottom: 15px; font-size: 13px;
        }
        .subtitle a { color: #00d9ff; text-decoration: none; }
        .subtitle a:hover { text-decoration: underline; }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
            position: relative;
        }
        input[type="text"] {
            flex: 1;
            padding: 13px 18px;
            font-size: 16px;
            border: 2px solid #333;
            border-radius: 10px;
            background: #16213e;
            color: #fff;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #00d9ff;
        }
        .search-btn {
            padding: 13px 28px;
            font-size: 16px;
            background: #00d9ff;
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .search-btn:hover { background: #00b8d9; }

        /* === Agent Pills === */
        .agent-bar {
            display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
            margin-bottom: 12px;
        }
        .agent-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 5px 12px; border-radius: 16px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            border: 2px solid transparent;
            background: #16213e; color: #888;
            transition: all 0.2s; user-select: none;
        }
        .agent-pill:hover { background: #1a2744; color: #ddd; }
        .agent-pill .pill-count { font-weight: normal; opacity: 0.7; font-size: 0.9em; }
        .agent-pill.active { color: #fff; }
        /* Active pill colors applied via inline styles from JS */
        .date-range-select {
            margin-left: auto; padding: 5px 10px; font-size: 12px;
            border-radius: 16px; background: #16213e; color: #aaa;
            border: 1px solid #333; cursor: pointer;
        }

        .options {
            display: flex; gap: 16px; margin-bottom: 14px; flex-wrap: wrap; align-items: center;
        }
        .options label {
            display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;
        }
        .options input[type="checkbox"] { width: 16px; height: 16px; accent-color: #00d9ff; }
        select {
            padding: 6px 12px; font-size: 13px; border-radius: 5px;
            background: #16213e; color: #fff; border: 1px solid #333;
        }

        .semantic-hint { color: #f90; font-size: 0.82em; margin-left: 12px; }
        .search-indicator {
            display: none; align-items: center; gap: 8px; color: #888; font-size: 0.9em; margin-bottom: 10px;
        }
        .search-indicator.visible { display: flex; }
        .spinner {
            width: 16px; height: 16px; border: 2px solid #333;
            border-top-color: #00d9ff; border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results & cards */
        .results { margin-top: 16px; }
        .section-title {
            font-size: 1.2em; color: #00d9ff; margin: 16px 0 8px;
            padding-bottom: 5px; border-bottom: 1px solid #333;
            display: flex; align-items: center; gap: 10px;
        }
        .result-count {
            font-size: 0.6em; background: #0f3460; color: #aaa;
            padding: 3px 10px; border-radius: 12px; font-weight: normal;
        }
        .result-card {
            background: #16213e; border-radius: 10px; padding: 14px;
            margin-bottom: 8px; cursor: pointer;
            transition: background 0.15s, border-color 0.2s;
            border: 1px solid transparent;
        }
        .result-card:hover { background: #1a2744; border-color: #333; }
        .result-card.expanded { border-color: rgba(0,217,255,0.3); }
        .result-header {
            display: flex; gap: 10px; font-size: 0.85em; color: #888;
            margin-bottom: 6px; align-items: center; flex-wrap: wrap;
        }
        .agent-badge {
            padding: 2px 10px; border-radius: 4px; font-weight: bold;
            font-size: 0.82em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        /* Agent badge colors applied via inline styles from JS */

        .result-date { color: #00d9ff; font-weight: 600; font-size: 0.95em; }
        .result-role { color: #aaa; font-style: italic; }
        .result-preview { line-height: 1.5; word-break: break-word; color: #ccc; font-size: 0.9em; }
        .deep-link {
            text-decoration: none; opacity: 0.6; margin-left: auto; padding: 2px 6px;
            border-radius: 4px; transition: opacity 0.2s, background 0.2s;
        }
        .deep-link:hover { opacity: 1; background: rgba(0,255,255,0.1); }
        mark { background: #00d9ff; color: #1a1a2e; padding: 1px 4px; border-radius: 3px; font-weight: bold; }

        /* Conversation viewer (inline expand) */
        /* convo-viewer styling is below in the expansion CSS section */
        .convo-msg {
            padding: 10px 12px; margin: 4px 0; border-radius: 6px;
            font-size: 0.88em; line-height: 1.6; word-break: break-word;
        }
        .tool-calls-summary {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; background: #0d1520; border: 1px solid #333;
            border-radius: 6px; color: #888; font-size: 0.82em;
            cursor: pointer; margin: 3px 0; transition: background 0.15s;
        }
        .tool-calls-summary:hover { background: #16213e; color: #aaa; }
        .msg-show-more {
            color: #00d9ff; cursor: pointer; font-size: 0.82em; opacity: 0.8;
            display: inline-block; margin-top: 4px;
        }
        .msg-show-more:hover { opacity: 1; text-decoration: underline; }
        .convo-loading { text-align: center; padding: 20px; color: #888; font-size: 0.9em; }
        .convo-collapse {
            text-align: center; padding: 6px; color: #00d9ff; font-size: 0.82em;
            cursor: pointer; margin-top: 4px;
        }
        .convo-collapse:hover { text-decoration: underline; }
        .activity-status { text-align: center; color: #888; padding: 30px 10px; font-size: 0.9em; }

        /* File results */
        .result-path { font-family: monospace; font-size: 0.9em; color: #aaa; }

        .summary { text-align: center; color: #888; margin-top: 20px; padding: 10px; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .empty { text-align: center; padding: 40px; color: #666; }

        .help-section {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #333;
        }
        .help-section h2 { text-align: center; color: #00d9ff; margin-bottom: 20px; }
        .help-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px; margin-bottom: 20px;
        }
        .help-card { background: #16213e; border-radius: 10px; padding: 16px; }
        .help-card h3 { color: #00d9ff; margin-bottom: 8px; font-size: 1em; }
        .help-card p { color: #aaa; font-size: 0.85em; margin-bottom: 12px; }
        .examples { display: flex; flex-direction: column; gap: 6px; }
        .examples code {
            background: #0f3460; padding: 6px 10px; border-radius: 5px;
            font-size: 0.85em; color: #fff; cursor: pointer; transition: background 0.15s;
        }
        .examples code:hover { background: #00d9ff; color: #1a1a2e; }

        .convo-load-btn {
            text-align: center; padding: 8px; color: #00d9ff; font-size: 0.82em;
            cursor: pointer; border: 1px dashed #333; border-radius: 6px; margin: 4px 0;
            transition: background 0.15s, border-color 0.15s;
        }
        .convo-load-btn:hover { background: rgba(0,217,255,0.08); border-color: #00d9ff; }
        .load-arrow { font-size: 0.9em; margin-right: 4px; }

        .show-more-btn {
            text-align: center; padding: 10px; color: #00d9ff; font-size: 0.88em;
            cursor: pointer; border: 1px dashed #333; border-radius: 8px; margin: 8px 0;
            transition: background 0.15s, border-color 0.15s;
        }
        .show-more-btn:hover { background: rgba(0,217,255,0.08); border-color: #00d9ff; }

        .convo-viewer { display: none; margin-top: 8px; border-top: 1px solid #333; }
        .convo-thread { padding: 8px 0; max-height: 500px; overflow-y: auto; }
        .convo-msg { padding: 8px 12px; margin: 4px 0; border-radius: 6px; }
        .convo-user { background: rgba(0,217,255,0.06); border-left: 3px solid #00d9ff; }
        .convo-assistant { background: rgba(100,255,100,0.05); border-left: 3px solid #4a7; }
        .convo-system { background: rgba(255,255,255,0.03); border-left: 3px solid #555; font-size: 0.85em; }
        .convo-highlight { box-shadow: 0 0 0 2px #f90 inset; }
        .convo-role-line { display: flex; gap: 10px; align-items: center; margin-bottom: 4px; }
        .convo-role { font-weight: 700; font-size: 0.82em; text-transform: uppercase; color: #aaa; }
        .convo-time { font-size: 0.78em; color: #666; }
        .convo-content { font-size: 0.9em; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
        .convo-content code { background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 3px; font-size: 0.9em; }
        .convo-content pre { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 6px; overflow-x: auto; margin: 6px 0; }
        .convo-content pre code { background: none; padding: 0; }
        .convo-show-more { color: #00d9ff; font-size: 0.82em; cursor: pointer; padding: 2px 0; }
        .convo-show-more:hover { text-decoration: underline; }
        .convo-tools-summary { color: #777; font-size: 0.82em; padding: 4px 12px; font-style: italic; }
        .load-more-btn { text-align: center; padding: 8px; color: #00d9ff; font-size: 0.85em; cursor: pointer; border: 1px dashed #444; border-radius: 6px; margin: 6px 0; }
        .load-more-btn:hover { background: rgba(0,217,255,0.08); border-color: #00d9ff; }
        .result-card.expanded { border-color: #00d9ff; }

        /* Mobile */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .search-btn, input[type="text"] { min-height: 44px; font-size: 16px; }
            .agent-pill { padding: 8px 14px; font-size: 13px; }
            .help-grid { grid-template-columns: 1fr; }
            .options { gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recall</h1>
        <div class="subtitle"><a href="https://devtracker.srv912889.hstgr.cloud/" target="_blank">Dev Tracker ‚Üó</a> <span style="color:#444;margin:0 8px;">|</span> <span style="color:#666;">Search conversation archives across all agents</span></div>

        <div class="search-box">
            <input type="text" id="query" placeholder="Search conversations and files..." autofocus>
            <button class="search-btn" onclick="doSearch()">Search</button>
        </div>

        <div class="agent-bar" id="agentBar">
            <select class="date-range-select" id="dateRange" onchange="onDateRangeChange()">
                <option value="1">Today</option>
                <option value="3">3 days</option>
                <option value="7">7 days</option>
                <option value="14" selected>14 days</option>
                <option value="30">30 days</option>
                <option value="0">All time</option>
            </select>
        </div>

        <div class="options">
            <label><input type="checkbox" id="semantic"> Semantic search</label>
            <label>Agent: <select id="agent">
                <option value="">All agents</option>
            </select></label>
            <label><input type="checkbox" id="filesOnly"> Files only</label>
            <label><input type="checkbox" id="convosOnly"> Conversations only</label>
        </div>

        <div class="search-indicator" id="searchIndicator">
            <div class="spinner"></div><span>Searching...</span>
        </div>
        <div id="semanticHint" class="semantic-hint" style="display:none;">Semantic mode: press Enter or click Search</div>

        <div id="results"></div>

        <div class="help-section" id="helpSection">
            <h2>Search Tips</h2>
            <div class="help-grid">
                <div class="help-card">
                    <h3>Keyword Search (Default)</h3>
                    <p>Finds exact word matches. Best for specific terms.</p>
                    <div class="examples">
                        <code>project update</code>
                        <code>meeting notes</code>
                        <code>API integration</code>
                    </div>
                </div>
                <div class="help-card">
                    <h3>Semantic Search</h3>
                    <p>Understands meaning. Enable the checkbox!</p>
                    <div class="examples">
                        <code>what did we decide about the website</code>
                        <code>how to handle customer requests</code>
                    </div>
                </div>
                <div class="help-card">
                    <h3>Agent Pills</h3>
                    <p>Click an agent pill to browse recent activity without searching.</p>
                    <div class="examples">
                        <code>Click Kit to see Kit's recent work</code>
                        <code>Click All to see everything</code>
                    </div>
                </div>
                <div class="help-card">
                    <h3>Click to Expand</h3>
                    <p>Click any result card to see the full conversation.</p>
                    <div class="examples">
                        <code>Click a card ‚Üí full conversation</code>
                        <code>Click again ‚Üí collapse</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let debounceTimer = null;
        let abortController = null;
        let searchId = 0;
        const DEBOUNCE_MS = 400;
        const TRUNCATE_LEN = 300;
        const MSG_TRUNCATE = 800;
        let expandedCard = null;
        let expandCardController = null;
        let loadedConvos = {};

        // --- Dynamic agent data (populated from /agents on page load) ---
        // Display name overrides for known agents
        const DISPLAY_OVERRIDES = { 'main': 'Kit', 'cc': 'CC', 'claude-code': 'Claude Code' };
        // Color palette for agent badges/pills ‚Äî cycles if more agents than colors
        const AGENT_COLORS = [
            { bg: '#2563eb', fg: '#fff', pill: 'rgba(37,99,235,0.25)', border: '#2563eb', text: '#5b9aff' },
            { bg: '#06b6d4', fg: '#1a1a2e', pill: 'rgba(6,182,212,0.25)', border: '#06b6d4', text: '#22d3ee' },
            { bg: '#8b5cf6', fg: '#fff', pill: 'rgba(139,92,246,0.25)', border: '#8b5cf6', text: '#a78bfa' },
            { bg: '#f59e0b', fg: '#1a1a2e', pill: 'rgba(245,158,11,0.25)', border: '#f59e0b', text: '#fbbf24' },
            { bg: '#ef4444', fg: '#fff', pill: 'rgba(239,68,68,0.25)', border: '#ef4444', text: '#f87171' },
            { bg: '#10b981', fg: '#1a1a2e', pill: 'rgba(16,185,129,0.25)', border: '#10b981', text: '#34d399' },
            { bg: '#6366f1', fg: '#fff', pill: 'rgba(99,102,241,0.25)', border: '#6366f1', text: '#818cf8' },
            { bg: '#ec4899', fg: '#fff', pill: 'rgba(236,72,153,0.25)', border: '#ec4899', text: '#f472b6' },
            { bg: '#14b8a6', fg: '#1a1a2e', pill: 'rgba(20,184,166,0.25)', border: '#14b8a6', text: '#2dd4bf' },
            { bg: '#f97316', fg: '#1a1a2e', pill: 'rgba(249,115,22,0.25)', border: '#f97316', text: '#fb923c' },
            { bg: '#a855f7', fg: '#fff', pill: 'rgba(168,85,247,0.25)', border: '#a855f7', text: '#c084fc' },
        ];
        let agentColorMap = {};  // agent_id ‚Üí color index
        let knownAgents = [];    // ordered list of agent_ids from DB

        function agentDisplayName(a) {
            if (!a) return 'unknown';
            const key = a.toLowerCase();
            if (DISPLAY_OVERRIDES[key]) return DISPLAY_OVERRIDES[key];
            return a.charAt(0).toUpperCase() + a.slice(1);
        }

        function agentColor(a) {
            const key = (a || '').toLowerCase();
            if (key in agentColorMap) return AGENT_COLORS[agentColorMap[key] % AGENT_COLORS.length];
            return { bg: '#555', fg: '#ccc', pill: 'rgba(85,85,85,0.25)', border: '#555', text: '#aaa' };
        }

        function agentBadgeStyle(a) {
            const c = agentColor(a);
            return 'background:' + c.bg + ';color:' + c.fg;
        }

        // --- Utilities ---
        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = String(t); return d.innerHTML; }
        function escapeAttr(t) { if (!t) return ''; return String(t).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function escapeAttr(t) { if (!t) return ''; return String(t).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function cleanNoise(text) {
            if (!text) return '';
            text = text.replace(/\[Telegram\s+[^\]]*\]\s*/g, '');
            text = text.replace(/\[Discord\s+[^\]]*\]\s*/g, '');
            text = text.replace(/\[message_id:\s*\d+\]\s*/g, '');
            return text.trim();
        }

        function highlightTerms(html, query) {
            if (!query) return html;
            const stopwords = new Set(['the','a','an','is','in','on','at','to','of','and','or','for','it','by','as']);
            const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1 && !stopwords.has(t));
            let r = html;
            for (const term of terms) {
                const e = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                try { r = r.replace(new RegExp('(' + e + ')', 'gi'), '<mark>$1</mark>'); } catch(x) {}
            }
            return r;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            let s = escapeHtml(text);
            s = s.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => '<pre><code>' + code.trim() + '</code></pre>');
            s = s.replace(/`([^`\n]+)`/g, '<code>$1</code>');
            s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            s = s.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            s = s.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            s = s.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            s = s.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
            s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            return s;
        }

        // --- Event listeners ---
        const queryInput = document.getElementById('query');
        queryInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { if (queryInput.value.trim().length >= 2 && !document.getElementById('semantic').checked) doSearch(); }, DEBOUNCE_MS);
        });
        queryInput.addEventListener('keypress', e => { if (e.key === 'Enter') { clearTimeout(debounceTimer); doSearch(); } });
        document.getElementById('agent').addEventListener('change', () => { if (queryInput.value.trim().length >= 2) doSearch(); });
        ['semantic', 'filesOnly', 'convosOnly'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => { if (queryInput.value.trim().length >= 2) doSearch(); });
        });
        // Show hint when semantic is toggled
        document.getElementById('semantic').addEventListener('change', function() {
            document.getElementById('semanticHint').style.display = this.checked ? 'inline' : 'none';
        });

        // --- Search ---
        async function doSearch() {
            const query = queryInput.value.trim();
            if (!query) { document.getElementById('results').innerHTML = ''; return; }
            if (abortController) abortController.abort();
            abortController = new AbortController();
            const mySearchId = ++searchId;
            document.getElementById('searchIndicator').classList.add('visible');
            document.getElementById('helpSection').style.display = 'none';
            // Deactivate pills during search
            document.querySelectorAll('.agent-pill').forEach(p => p.classList.remove('active'));
            try {
                const isSemantic = document.getElementById('semantic').checked;
                // Strip quotes for semantic search ‚Äî they don't help embedding models
                const searchQuery = isSemantic ? query.replace(/^["']|["']$/g, '') : query;
                const params = new URLSearchParams({
                    q: searchQuery,
                    semantic: String(isSemantic),
                    days: document.getElementById('dateRange').value,
                    agent: document.getElementById('agent').value || '',
                    files_only: String(document.getElementById('filesOnly').checked),
                    convos_only: String(document.getElementById('convosOnly').checked)
                });
                const resp = await fetch('/search?' + params, { signal: abortController.signal });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                // Only render if this is still the latest search
                if (mySearchId === searchId) {
                    renderResults(data, query);
                }
            } catch (err) {
                if (err.name === 'AbortError') return;
                if (mySearchId === searchId) {
                    document.getElementById('results').innerHTML = '<div class="empty">Error: ' + escapeHtml(err.message) + '</div>';
                }
            } finally {
                // Only hide spinner if this is still the latest search
                if (mySearchId === searchId) {
                    document.getElementById('searchIndicator').classList.remove('visible');
                }
            }
        }

        const INITIAL_SHOW = 5;
        let lastSearchData = null;
        let lastSearchQuery = '';
        let convoShowCount = 5;
        let fileShowCount = 5;

        function renderResultCard(r, idx, query) {
            if (r.error) return '<div class="result-card">' + escapeHtml(r.error) + '</div>';
            const dateStr = r.timestamp ? r.timestamp.substring(0, 10) : '';
            const timeStr = r.timestamp ? r.timestamp.substring(11, 16) : '';
            const display = agentDisplayName(r.agent);
            const badgeStyle = agentBadgeStyle(r.agent);
            const content = cleanNoise(r.content || '');
            const preview = content.length > TRUNCATE_LEN ? content.substring(0, TRUNCATE_LEN) + '...' : content;
            const sid = escapeAttr(r.session_id || '');
            const cardId = 'sr-' + idx;

            return '<div class="result-card" id="' + cardId + '" data-session="' + sid + '" data-msg-id="' + (r.message_id || '') + '" onclick="toggleSearchCard(\'' + cardId + '\', \'' + sid + '\')">' +
                '<div class="result-header">' +
                '<span class="agent-badge" style="' + badgeStyle + '">' + escapeHtml(display) + '</span>' +
                '<span class="result-date">' + escapeHtml(dateStr) + '</span>' +
                '<span>' + escapeHtml(timeStr) + '</span>' +
                '<span class="result-role">' + escapeHtml(r.role || '') + '</span>' +
                (r.deepLink ? '<a href="' + escapeAttr(r.deepLink) + '" target="_blank" class="deep-link" onclick="event.stopPropagation()">&#128279;</a>' : '') +
                '</div>' +
                '<div class="result-preview">' + highlightTerms(escapeHtml(preview), query) + '</div>' +
                '<div class="convo-viewer" id="cv-' + cardId + '"></div>' +
                '</div>';
        }

        function renderFileCard(r, query) {
            if (r.error) return '';
            const display = agentDisplayName(r.agent);
            const badgeStyle = agentBadgeStyle(r.agent);
            return '<div class="result-card" style="cursor:default"><div class="result-header">' +
                '<span class="agent-badge" style="' + badgeStyle + '">' + escapeHtml(display) + '</span>' +
                '<span class="result-path">' + escapeHtml(r.path || '') + ':' + (r.line_num || '') + '</span>' +
                '</div><div class="result-preview">' + highlightTerms(escapeHtml(r.line || ''), query) + '</div></div>';
        }

        function renderResults(data, query) {
            lastSearchData = data;
            lastSearchQuery = query;
            convoShowCount = INITIAL_SHOW;
            fileShowCount = INITIAL_SHOW;
            expandedCard = null;
            cardState = {};
            doRenderResults();
        }

        function doRenderResults() {
            const data = lastSearchData;
            const query = lastSearchQuery;
            if (!data) return;
            let html = '';

            const convos = data.conversations || [];
            if (convos.length) {
                html += '<div class="section-title">Conversations <span class="result-count">' + convos.length + ' result' + (convos.length !== 1 ? 's' : '') + '</span></div>';
                const showing = Math.min(convoShowCount, convos.length);
                for (let i = 0; i < showing; i++) {
                    html += renderResultCard(convos[i], i, query);
                }
                if (showing < convos.length) {
                    html += '<div class="show-more-btn" onclick="convoShowCount += 5; doRenderResults();">Show more conversations (' + (convos.length - showing) + ' remaining)</div>';
                }
            }

            const files = data.files || [];
            if (files.length) {
                html += '<div class="section-title">Files <span class="result-count">' + files.length + ' result' + (files.length !== 1 ? 's' : '') + '</span></div>';
                const showing = Math.min(fileShowCount, files.length);
                for (let i = 0; i < showing; i++) {
                    html += renderFileCard(files[i], query);
                }
                if (showing < files.length) {
                    html += '<div class="show-more-btn" onclick="fileShowCount += 5; doRenderResults();">Show more files (' + (files.length - showing) + ' remaining)</div>';
                }
            }

            if (!html) html = '<div class="empty">No results found</div>';
            html += '<div class="summary">' + escapeHtml(data.summary || '') + '</div>';
            document.getElementById('results').innerHTML = html;
        }

        // --- Conversation expansion ---
        async function toggleSearchCard(cardId, sessionId) {
            const card = document.getElementById(cardId);
            const viewer = document.getElementById('cv-' + cardId);
            if (!card || !viewer) return;

            // Collapse if already expanded
            if (expandedCard === cardId) {
                viewer.style.display = 'none';
                card.classList.remove('expanded');
                expandedCard = null;
                return;
            }

            // Collapse previous card (but keep its cached data)
            if (expandedCard) {
                const prev = document.getElementById(expandedCard);
                const prevV = document.getElementById('cv-' + expandedCard);
                if (prev) prev.classList.remove('expanded');
                if (prevV) { prevV.innerHTML = ''; prevV.style.display = 'none'; }
            }

            // Cancel any in-flight expansion fetch
            if (expandCardController) expandCardController.abort();
            expandCardController = new AbortController();

            expandedCard = cardId;
            card.classList.add('expanded');
            viewer.style.display = 'block';

            const msgId = card.dataset.msgId || '';

            // Reuse cached conversation data if available
            if (loadedConvos[sessionId]) {
                renderConvo(viewer, loadedConvos[sessionId], sessionId, msgId, lastSearchQuery);
                return;
            }

            viewer.innerHTML = '<div style="text-align:center;padding:12px;color:#888;">Loading conversation...</div>';

            try {
                let url;
                if (msgId) {
                    url = '/context?session_id=' + encodeURIComponent(sessionId) + '&message_id=' + encodeURIComponent(msgId) + '&radius=15';
                } else {
                    url = '/session?session_id=' + encodeURIComponent(sessionId) + '&window=30';
                }
                const resp = await fetch(url, { signal: expandCardController.signal });
                if (!resp.ok) { viewer.innerHTML = '<div style="color:#f44;">Failed to load (HTTP ' + resp.status + ')</div>'; return; }
                const data = await resp.json();
                if (data.error) { viewer.innerHTML = '<div style="color:#f44;">' + escapeHtml(data.error) + '</div>'; return; }
                loadedConvos[sessionId] = data;
                renderConvo(viewer, data, sessionId, msgId, lastSearchQuery);
            } catch (e) {
                if (e.name === 'AbortError') return;
                viewer.innerHTML = '<div style="color:#f44;">Error: ' + escapeHtml(e.message) + '</div>';
            }
        }

        function renderConvo(container, data, sessionId, highlightMsgId, searchQuery) {
            const msgs = data.messages || [];
            if (!msgs.length) {
                container.innerHTML = '<div style="padding:8px;color:#888;">No messages in this session</div>';
                return;
            }

            const thread = document.createElement('div');
            thread.className = 'convo-thread';

            if (data.has_more_before) {
                const btn = document.createElement('div');
                btn.className = 'load-more-btn';
                btn.textContent = 'Load earlier messages';
                btn.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    loadMore('earlier', sessionId, msgs[0].message_index, container);
                });
                thread.appendChild(btn);
            }

            let toolCount = 0;
            function flushTools() {
                if (!toolCount) return;
                const summary = document.createElement('div');
                summary.className = 'convo-tools-summary';
                summary.textContent = toolCount + ' tool call' + (toolCount > 1 ? 's' : '');
                thread.appendChild(summary);
                toolCount = 0;
            }

            for (const m of msgs) {
                const role = m.role || '';
                if (role === 'tool_use' || role === 'tool_result' || role === 'tool') {
                    toolCount++;
                    continue;
                }
                flushTools();

                if (role === 'system' && !(m.content || '').trim()) continue;

                const isHighlight = highlightMsgId && (String(m.id) === String(highlightMsgId) || m.is_match === true);
                const roleClass = role === 'user' ? 'convo-user' : role === 'assistant' ? 'convo-assistant' : 'convo-system';

                const msgDiv = document.createElement('div');
                msgDiv.className = 'convo-msg ' + roleClass + (isHighlight ? ' convo-highlight' : '');

                const roleLine = document.createElement('div');
                roleLine.className = 'convo-role-line';
                const roleSpan = document.createElement('span');
                roleSpan.className = 'convo-role';
                roleSpan.textContent = role;
                roleLine.appendChild(roleSpan);
                const time = m.timestamp ? m.timestamp.substring(11, 16) : '';
                if (time) {
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'convo-time';
                    timeSpan.textContent = time;
                    roleLine.appendChild(timeSpan);
                }
                msgDiv.appendChild(roleLine);

                const content = cleanNoise(m.content || '');
                const isTruncated = content.length > MSG_TRUNCATE;
                const displayContent = isTruncated ? content.substring(0, MSG_TRUNCATE) : content;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'convo-content';
                contentDiv.innerHTML = searchQuery ? highlightTerms(renderMarkdown(escapeHtml(displayContent)), searchQuery) : renderMarkdown(escapeHtml(displayContent));
                msgDiv.appendChild(contentDiv);

                if (isTruncated) {
                    const showMore = document.createElement('div');
                    showMore.className = 'convo-show-more';
                    showMore.textContent = 'Show more';
                    showMore.addEventListener('click', (function(fullContent, cd, sm) {
                        return function(ev) {
                            ev.stopPropagation();
                            cd.innerHTML = renderMarkdown(escapeHtml(fullContent));
                            sm.remove();
                        };
                    })(content, contentDiv, showMore));
                    msgDiv.appendChild(showMore);
                }

                thread.appendChild(msgDiv);
            }
            flushTools();

            if (data.has_more_after) {
                const btn = document.createElement('div');
                btn.className = 'load-more-btn';
                btn.textContent = 'Load later messages';
                btn.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    loadMore('later', sessionId, msgs[msgs.length - 1].message_index, container);
                });
                thread.appendChild(btn);
            }

            container.innerHTML = '';
            container.appendChild(thread);

            if (highlightMsgId) {
                setTimeout(function() {
                    const hl = container.querySelector('.convo-highlight');
                    if (hl) {
                        var thread = hl.closest('.convo-thread');
                        if (thread) {
                            thread.scrollTop = hl.offsetTop - thread.offsetTop - (thread.clientHeight / 2) + (hl.offsetHeight / 2);
                        }
                    }
                }, 100);
            }
        }

        let loadMoreBusy = false;
        async function loadMore(direction, sessionId, fromIdx, container) {
            if (!container || loadMoreBusy) return;
            loadMoreBusy = true;
            const around = direction === 'earlier' ? fromIdx - 15 : fromIdx + 15;
            try {
                const resp = await fetch('/session?session_id=' + encodeURIComponent(sessionId) + '&around=' + around + '&window=30');
                if (!resp.ok) return;
                const data = await resp.json();
                const existing = loadedConvos[sessionId];
                if (existing) {
                    const existingIdxs = new Set(existing.messages.map(function(m) { return m.message_index; }));
                    for (const m of data.messages) {
                        if (!existingIdxs.has(m.message_index)) {
                            existing.messages.push(m);
                        }
                    }
                    existing.messages.sort(function(a, b) { return a.message_index - b.message_index; });
                    existing.has_more_before = data.has_more_before;
                    existing.has_more_after = data.has_more_after;
                    renderConvo(container, existing, sessionId, '', lastSearchQuery);
                } else {
                    loadedConvos[sessionId] = data;
                    renderConvo(container, data, sessionId, '', lastSearchQuery);
                }
            } catch (e) {
                console.error('loadMore error:', e);
            } finally {
                loadMoreBusy = false;
            }
        }

        // --- Pill state ---
        const pillState = {
            activeAgent: null,
            agentCounts: {},
            sessions: [],
        };

        function renderPills() {
            const bar = document.getElementById('agentBar');
            // Keep the date range select, remove old pills
            const dateSelect = bar.querySelector('.date-range-select');
            bar.innerHTML = '';

            // "All" pill
            const allPill = document.createElement('span');
            allPill.className = 'agent-pill' + (pillState.activeAgent === null ? ' active' : '');
            if (pillState.activeAgent === null) allPill.style.cssText = 'background:#0f3460;border-color:#00d9ff;color:#00d9ff;';
            const totalCount = Object.values(pillState.agentCounts).reduce((a, b) => a + b, 0);
            allPill.innerHTML = 'All <span class="pill-count">' + totalCount + '</span>';
            allPill.addEventListener('click', () => { pillState.activeAgent = null; renderPills(); loadActivity(null); });
            bar.appendChild(allPill);

            // Agent pills in order
            for (const agentId of knownAgents) {
                const count = pillState.agentCounts[agentId] || 0;
                if (count === 0) continue;
                const color = agentColor(agentId);
                const pill = document.createElement('span');
                const isActive = pillState.activeAgent === agentId;
                pill.className = 'agent-pill' + (isActive ? ' active' : '');
                if (isActive) pill.style.cssText = 'background:' + color.pill + ';border-color:' + color.border + ';color:' + color.text + ';';
                pill.innerHTML = escapeHtml(agentDisplayName(agentId)) + ' <span class="pill-count">' + count + '</span>';
                pill.addEventListener('click', ((id) => () => {
                    pillState.activeAgent = id;
                    renderPills();
                    loadActivity(id);
                })(agentId));
                bar.appendChild(pill);
            }

            bar.appendChild(dateSelect);
        }

        async function loadActivity(agentId) {
            const days = document.getElementById('dateRange').value;
            document.getElementById('helpSection').style.display = 'none';
            document.getElementById('results').innerHTML = '<div class="activity-status">Loading activity...</div>';
            try {
                const params = new URLSearchParams({ days: days, limit: '30' });
                if (agentId) params.set('agent', agentId);
                const resp = await fetch('/activity?' + params);
                if (!resp.ok) return;
                const data = await resp.json();
                pillState.sessions = data.sessions || [];
                pillState.agentCounts = data.agent_counts || {};
                renderPills();
                renderActivityResults(data.sessions || []);
            } catch (e) {
                document.getElementById('results').innerHTML = '<div class="empty">Error loading activity</div>';
            }
        }

        function renderActivityResults(sessions) {
            if (!sessions.length) {
                document.getElementById('results').innerHTML = '<div class="empty">No recent activity</div>';
                return;
            }
            let html = '<div class="section-title">Recent Activity <span class="result-count">' + sessions.length + ' session' + (sessions.length !== 1 ? 's' : '') + '</span></div>';
            for (let i = 0; i < sessions.length; i++) {
                const s = sessions[i];
                const display = agentDisplayName(s.agent);
                const badgeStyle = agentBadgeStyle(s.agent);
                const dateStr = s.started_at ? s.started_at.substring(0, 10) : '';
                const timeStr = s.started_at ? s.started_at.substring(11, 16) : '';
                const preview = cleanNoise(s.first_user_message || '');
                const truncated = preview.length > TRUNCATE_LEN ? preview.substring(0, TRUNCATE_LEN) + '...' : preview;
                const cardId = 'act-' + i;
                html += '<div class="result-card" id="' + cardId + '" data-session="' + escapeAttr(s.session_id) + '" onclick="toggleSearchCard(\'' + cardId + '\', \'' + escapeAttr(s.session_id) + '\')">' +
                    '<div class="result-header">' +
                    '<span class="agent-badge" style="' + badgeStyle + '">' + escapeHtml(display) + '</span>' +
                    '<span class="result-date">' + escapeHtml(dateStr) + '</span>' +
                    '<span>' + escapeHtml(timeStr) + '</span>' +
                    '<span style="color:#666;">' + (s.message_count || 0) + ' msgs</span>' +
                    '</div>' +
                    '<div class="result-preview">' + escapeHtml(truncated) + '</div>' +
                    '<div class="convo-viewer" id="cv-' + cardId + '"></div>' +
                    '</div>';
            }
            document.getElementById('results').innerHTML = html;
        }

        function onDateRangeChange() {
            (async () => {
                const days = document.getElementById('dateRange').value;
                try {
                    const resp = await fetch('/agents?days=' + days);
                    if (!resp.ok) return;
                    const data = await resp.json();
                    pillState.agentCounts = data;
                    loadedConvos = {};
                    renderPills();
                } catch (e) {}
                if (pillState.activeAgent !== null || pillState.sessions.length > 0) {
                    await loadActivity(pillState.activeAgent);
                }
            })();
        }

        // --- Page initialization: fetch agents, build pills + dropdown ---
        (async function initAgents() {
            try {
                const days = document.getElementById('dateRange').value;
                const resp = await fetch('/agents?days=' + days);
                if (!resp.ok) return;
                const data = await resp.json();
                // data is { agent_id: count, ... } ordered by count desc
                knownAgents = Object.keys(data);
                knownAgents.forEach((id, i) => { agentColorMap[id.toLowerCase()] = i; });
                pillState.agentCounts = data;

                // Populate agent dropdown
                const select = document.getElementById('agent');
                for (const agentId of knownAgents) {
                    const opt = document.createElement('option');
                    opt.value = agentId;
                    opt.textContent = agentDisplayName(agentId);
                    select.appendChild(opt);
                }

                // Render pills
                renderPills();
            } catch (e) {
                console.error('Failed to load agents:', e);
            }
        })();

        // Make example searches clickable
        document.querySelectorAll('.examples code').forEach(el => {
            el.addEventListener('click', () => {
                if (el.textContent.startsWith('Click')) return;
                queryInput.value = el.textContent;
                doSearch();
            });
        });
    </script>
</body>
</html>
